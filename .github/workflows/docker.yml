name: Build K620 Image

on:
  push:
    branches: [ "main" ]

  workflow_dispatch:

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    env:
      DOCKER_USERNAME: ${{ github.actor }}
      DOCKER_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
      IMAGE_NAME: k620 
      REGISTRY: ghcr.io

    steps:
    - name: 检查代码 (Checkout repository)
      uses: actions/checkout@v4

    - name: 设置 Docker Buildx (Setup Docker Buildx)
      # Buildx 允许构建多平台镜像，强烈推荐
      uses: docker/setup-buildx-action@v3

    - name: 登录到 GHCR 仓库 (Login to GHCR)
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ DOCKER_USERNAME }}
        password: ${{ DOCKER_PASSWORD }}
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: 构建并推送到 Docker 仓库 (Build and push Docker image)
      uses: docker/build-push-action@v5
      with:
        context: . 
        push: true 
        tags: |
          ghcr.io/${{ github.repository_owner }}/${{ IMAGE_NAME }}:latest
        labels: |
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
          org.opencontainers.image.description=Mozart K620: Die Zauberflote
          org.opencontainers.image.licenses=MIT
        cache-from: type=gha
        cache-to: type=gha,mode=max
